<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار كاميرا التقاط الصور</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8f9fa;
        }
        .camera-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 2rem;
            margin: 2rem auto;
            max-width: 600px;
        }
        .preview-image {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-group .btn-check:checked + .btn {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="camera-section">
            <h2 class="text-center mb-4">
                <i class="fas fa-camera me-2"></i>
                اختبار كاميرا التقاط الصور
            </h2>

            <!-- Tab buttons for capture methods -->
            <div class="btn-group d-flex mb-4" role="group">
                <input type="radio" class="btn-check" name="capture_method" id="camera_method" value="camera" autocomplete="off" checked>
                <label class="btn btn-outline-primary" for="camera_method">
                    <i class="fas fa-camera me-1"></i> التقاط بالكاميرا
                </label>

                <input type="radio" class="btn-check" name="capture_method" id="file_method" value="file" autocomplete="off">
                <label class="btn btn-outline-primary" for="file_method">
                    <i class="fas fa-upload me-1"></i> رفع من الملفات
                </label>
            </div>

            <!-- Camera capture section -->
            <div id="camera_section" class="capture-section">
                <video id="camera_video" style="width: 100%; max-height: 400px; border-radius: 8px; display: none;" autoplay></video>
                <canvas id="camera_canvas" style="display: none;"></canvas>
                
                <div class="d-grid gap-2 mb-3">
                    <button type="button" id="start_camera" class="btn btn-primary btn-lg">
                        <i class="fas fa-video me-2"></i> تشغيل الكاميرا
                    </button>
                    <button type="button" id="capture_photo" class="btn btn-success btn-lg" style="display: none;">
                        <i class="fas fa-camera me-2"></i> التقاط صورة
                    </button>
                    <button type="button" id="retake_photo" class="btn btn-warning btn-lg" style="display: none;">
                        <i class="fas fa-redo me-2"></i> إعادة التصوير
                    </button>
                </div>
            </div>

            <!-- File upload section -->
            <div id="file_section" class="capture-section mb-3" style="display: none;">
                <input type="file" name="image" id="file_input" class="form-control" accept="image/*">
            </div>

            <!-- Hidden field to store captured image data -->
            <input type="hidden" name="captured_image_data" id="captured_image_data">
            
            <!-- Preview section -->
            <div class="text-center">
                <h5 class="mb-3">معاينة الصورة:</h5>
                <img id="image_preview" src="#" alt="معاينة الصورة" 
                     class="preview-image" style="display:none;">
            </div>

            <!-- Test results -->
            <div class="mt-4">
                <h5>نتائج الاختبار:</h5>
                <div id="test_results" class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    اضغط على "تشغيل الكاميرا" لبدء الاختبار
                </div>
            </div>

            <!-- Device info -->
            <div class="mt-4">
                <h5>معلومات الجهاز:</h5>
                <div id="device_info" class="alert alert-secondary">
                    <small>
                        <strong>المتصفح:</strong> <span id="browser_info"></span><br>
                        <strong>نظام التشغيل:</strong> <span id="os_info"></span><br>
                        <strong>دعم الكاميرا:</strong> <span id="camera_support"></span>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <script>
        let stream = null;
        let capturedImageData = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Display device info
            document.getElementById('browser_info').textContent = navigator.userAgent.split(' ')[0];
            document.getElementById('os_info').textContent = navigator.platform;
            document.getElementById('camera_support').textContent = 
                navigator.mediaDevices && navigator.mediaDevices.getUserMedia ? 'مدعوم' : 'غير مدعوم';

            // Camera functionality
            const cameraMethod = document.getElementById('camera_method');
            const fileMethod = document.getElementById('file_method');
            const cameraSection = document.getElementById('camera_section');
            const fileSection = document.getElementById('file_section');
            const startCameraBtn = document.getElementById('start_camera');
            const capturePhotoBtn = document.getElementById('capture_photo');
            const retakePhotoBtn = document.getElementById('retake_photo');
            const video = document.getElementById('camera_video');
            const canvas = document.getElementById('camera_canvas');
            const preview = document.getElementById('image_preview');
            const capturedImageInput = document.getElementById('captured_image_data');
            const fileInput = document.getElementById('file_input');
            const testResults = document.getElementById('test_results');

            // Switch between camera and file methods
            cameraMethod.addEventListener('change', function() {
                if (this.checked) {
                    cameraSection.style.display = 'block';
                    fileSection.style.display = 'none';
                    stopCamera();
                    updateTestResults('تم التبديل إلى وضع الكاميرا', 'info');
                }
            });

            fileMethod.addEventListener('change', function() {
                if (this.checked) {
                    cameraSection.style.display = 'none';
                    fileSection.style.display = 'block';
                    stopCamera();
                    clearPreview();
                    updateTestResults('تم التبديل إلى وضع رفع الملفات', 'info');
                }
            });

            // Start camera
            startCameraBtn.addEventListener('click', async function() {
                try {
                    updateTestResults('جاري محاولة الوصول إلى الكاميرا...', 'info');
                    
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    });
                    
                    video.srcObject = stream;
                    video.style.display = 'block';
                    startCameraBtn.style.display = 'none';
                    capturePhotoBtn.style.display = 'block';
                    
                    updateTestResults('✅ تم تشغيل الكاميرا بنجاح! يمكنك الآن التقاط صورة.', 'success');
                } catch (err) {
                    console.error('Error accessing camera:', err);
                    updateTestResults('❌ لا يمكن الوصول إلى الكاميرا: ' + err.message, 'danger');
                }
            });

            // Capture photo
            capturePhotoBtn.addEventListener('click', function() {
                try {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const context = canvas.getContext('2d');
                    context.drawImage(video, 0, 0);
                    
                    capturedImageData = canvas.toDataURL('image/jpeg', 0.8);
                    capturedImageInput.value = capturedImageData;
                    
                    preview.src = capturedImageData;
                    preview.style.display = 'block';
                    
                    capturePhotoBtn.style.display = 'none';
                    retakePhotoBtn.style.display = 'block';
                    
                    stopCamera();
                    
                    updateTestResults('✅ تم التقاط الصورة بنجاح! حجم الصورة: ' + 
                                    Math.round(capturedImageData.length * 0.75 / 1024) + ' KB', 'success');
                } catch (err) {
                    console.error('Error capturing photo:', err);
                    updateTestResults('❌ خطأ في التقاط الصورة: ' + err.message, 'danger');
                }
            });

            // Retake photo
            retakePhotoBtn.addEventListener('click', function() {
                clearPreview();
                capturedImageData = null;
                capturedImageInput.value = '';
                retakePhotoBtn.style.display = 'none';
                startCameraBtn.style.display = 'block';
                startCameraBtn.click(); // Restart camera
                updateTestResults('تم إعادة تعيين الكاميرا', 'info');
            });

            // File input change handler
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        preview.src = event.target.result;
                        preview.style.display = 'block';
                        updateTestResults('✅ تم تحميل الملف بنجاح! حجم الملف: ' + 
                                        Math.round(file.size / 1024) + ' KB', 'success');
                    };
                    reader.readAsDataURL(file);
                } else {
                    clearPreview();
                }
            });

            // Helper functions
            function stopCamera() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                video.style.display = 'none';
            }

            function clearPreview() {
                preview.src = '#';
                preview.style.display = 'none';
            }

            function updateTestResults(message, type) {
                testResults.className = `alert alert-${type}`;
                testResults.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>${message}`;
            }

            // Cleanup on page unload
            window.addEventListener('beforeunload', function() {
                stopCamera();
            });
        });
    </script>
</body>
</html>
